name: Blue-Green Deployment

on:
  push:
    branches: [main]

jobs:
  CD:
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      IMAGE_NAME: bigbang
      IMAGE_TAG: ${{ github.sha }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Google Cloud SDK ì„¤ì •
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: GKE í´ëŸ¬ìŠ¤í„° ì¸ì¦
        run: gcloud container clusters get-credentials cluster-1 --region us-central1

      - name: ìƒˆ ë²„ì „ (`bigbang-green`) ë°°í¬
        run: kubectl apply -f ./k8s/deployment-green.yaml

      - name: ë°°í¬ í›„ `green` ìƒíƒœ í™•ì¸
        run: |
          echo "ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
          sleep 10 
          GREEN_STATUS=$(kubectl get deployment bigbang-green -o jsonpath='{.status.conditions[?(@.type=="Available")].status}')
          if [ "$GREEN_STATUS" != "True" ]; then
            echo "âŒ Green ë°°í¬ ì‹¤íŒ¨! ì¦‰ì‹œ Blueë¡œ ë¡¤ë°± ì§„í–‰..."
            kubectl patch service bigbang-service -p '{"spec":{"selector":{"app":"bigbang", "version":"blue"}}}'
            exit 1  # CI/CD ì‹¤íŒ¨ë¡œ ë§ˆí‚¹
          fi

      - name: íŠ¸ë˜í”½ ì „í™˜ (`bigbang-blue` â†’ `bigbang-green`)
        run: |
          kubectl patch service bigbang-service -p '{"spec":{"selector":{"app":"bigbang", "version":"green"}}}'
          echo "âœ… íŠ¸ë˜í”½ì´ Green í™˜ê²½ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!"

      - name: ê¸°ì¡´ (`bigbang-blue`) ì œê±° (ì„ íƒ)
        run: |
          sleep 10
          kubectl delete deployment bigbang-blue --ignore-not-found=true
          echo "ğŸš€ ê¸°ì¡´ Blue ë°°í¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!"